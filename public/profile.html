<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zalando+Sans+SemiExpanded:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <title>E-market</title>
    <link rel="stylesheet" href="profile.css">
   
</head>
<body>
    <section class="hero-section">
    <header class="main-header" id="main-header">
        <div class="logo-with-img"id="logo--with-img">
        <img src="images/logo_trimmed-removebg.png" alt="logo" id="logo-img"class="logo-img">
        <h1 class="logo"id="logo">E-market</h1></div>
        <div class="search-input-container" id="search-input-container">
    <input class="search-input" id="search-input"><button class="search-button"><span class="material-symbols-outlined">
search
</span></button></div>
       <nav class="main-nav" id="main-nav">
            <ul class="nav-list-container" id="nav-list-container">
                <li ><span class="icon-with-title"><a href="/" class="nav-link"><span class="material-symbols-outlined">
                home
                </span><span class="icon-title">home</span></span></a></li>
                <li ><span class="icon-with-title"><a href="/products" class="nav-link"><span class="material-symbols-outlined">
                local_mall
                </span><span class="icon-title">products</span></span></a></li>
                <li ><span class="icon-with-title"><a href="/cart" class="nav-link"><span class="material-symbols-outlined">
                shopping_cart_checkout
                </span><span class="icon-title">cart</span></span></a></li>
                <li ><span class="icon-with-title"><a href="/profile" class="nav-link"><span class="material-symbols-outlined">
                account_box
                </span><span class="icon-title">profile</span></span></a></li>
                <li ><span class="icon-with-title"><a href="/contact-us" class="nav-link"><span class="material-symbols-outlined">
                more_vert
                </span><span class="icon-title">more</span></span></a></li>
            </ul>   
    </header>
    <div class="error-box" style="display: none;background: red;"></div>
    <div class="profile">
    <div class="picture-container"><img src="images/profile-picture.jpg" alt="profile-picture" class="picture">
    <form action="/upload/image" class="uploadForm" enctype="multipart/form-data" >  <span class="edit-photo">edit picture</span>
        <input type="file" accept="image/*"name="image" class="input-photo" style="display: none;"></input >
    <button type="submit" class="upload"value='false' style="display: none;">Upload</button></form> <span class="fullName"id="fullName">Loading</span><span class="edit-name" >edit name</span>
    <div class="email" id="email">Loading</div></div>
<div class="balance-div">00.00</div>
<button class="recharge-button">Recharge balance</button>
<form action="/logout"class="form" ><button type="submit" class="submitButton">Log out</button></form>
</div>

    <!-- Transaction history section -->
    <div class="transaction-history">
        <h2 class="section-title">Transaction history</h2>
        <div class="transactions-list" id="transactions-list">
            <!-- Transaction cards will be injected here by script -->
             <div class="tlCard tlCardSkeleton">
                <div class="first-container">
                <div class="skeleton skeleton-circle"></div>
                </div>
                <div class="middle-container">
                    <div class="pTitle skeleton skeleton-text skeleton-title"></div>
                    <div class="pQuantity skeleton skeleton-text skeleton-qty"></div>
                    <div class="pPrice skeleton skeleton-text skeleton-price"></div>
                </div>
                <div class="last-container"><div class="skeleton skeleton-text skeleton-box"></div>
            <div class="skeleton order-id"></div>
        <div class="skeleton created-at"></div></div>
             </div>
        </div>
    </div>
<button class="more">More...</button>

</section>

</body>
<script>
    const errorBox=document.querySelector(".error-box");
    const picture=document.querySelector(".picture");
    const editName=document.querySelector(".edit-name");
    const inputPic=document.querySelector(".input-photo");
    const uploadBtn=document.querySelector(".upload");
    const fullName=document.getElementById("fullName");
    const email=document.getElementById("email");
    const balance_div=document.querySelector('.balance-div');
    const rechargeButton=document.querySelector(".recharge-button");
    const form=document.querySelector(".form");
    const logoutButton=document.querySelector(".submitButton");
    const transactionHistoryDiv=document.querySelector(".transactions-list");
    const tlCard=document.querySelector(".tlCardSkeleton");
    const more=document.querySelector(".more");
    const uploadForm=document.querySelector(".uploadForm");
    const editPhoto=document.querySelector(".edit-photo");
    let cardQuery='';
    let limit=4,offset=0;
function notification(type,message){
        console.log(message);
        errorBox.style.background=type===1?'var(--clr-success)':'var(--clr-error)';
        errorBox.textContent=message?message:"unknown error"
        errorBox.style.display='block';
        setTimeout(()=>{errorBox.style.display='none'},2500);
};

async function fetchUser(){
        const data =await fetch("/api/me");
        const user=await data.json();
    if(data.status!==200)return notification(0,user);
    fullName.textContent=user.fullname;
    email.textContent=user.email;
    balance_div.textContent=user.balance;
    picture.src=user.image?`/users-profile-picture/${user.image}`:"/images/profile-picture.jpg";
    };

form.addEventListener('submit',async()=>{
        event.preventDefault();
       const result= await fetch("/logout",{
            method:"post",
            headers:{"content-Type":"application/json"}
        })
        if (result.status===200){
            return location.href='/login'
        }
    });

picture.addEventListener("click",()=>{
    picture.id=picture.id?'':'expanded';
})

editPhoto.addEventListener("click",()=>{
    inputPic.style.display='inline-block';
    editPhoto.style.display='none';
})

inputPic.addEventListener("change",(e)=>{
    const file=e.target.files[0];
    if(!file || !file.type.startsWith("image/"))return notification(0,'input type should be image');
    picture.src=URL.createObjectURL(file);
    picture.onload=(()=>{URL.revokeObjectURL(picture.src);
    uploadBtn.value=uploadBtn.value=='false'?'true':'false';
    console.log(uploadBtn.value,'value==false',uploadBtn.value=='false')
    uploadBtn.style.display=uploadBtn.value=='true'?'inline-block':'none';
    });

});

uploadForm.addEventListener("submit",async(e)=>{
    e.preventDefault();
    uploadBtn.disabled=true;
    uploadBtn.textContent='uploading...';
    const file=inputPic.files[0];
    const formData=new FormData();
    formData.append("image",file)
    const result=await fetch("/upload/image",{
        method:"post",
        body:formData
    })
    const data=await result.json();
    if(result.status===200){
        picture.src=`/users-profile-picture/${data.fileName}`;
        
        uploadBtn.textContent='Upload';
        uploadBtn.disabled=false;
        
        inputPic.style.display='none';
        editPhoto.style.display='inline-block';
        return notification(1,data.message);}
    else if(result.status===400||result.status===401||result.status===500&&data){
        uploadBtn.textContent='Upload';
        uploadBtn.disabled=false;
       return  notification(0,data);
    }
    else return notification(0,"UNKOWN ERROR")
    });

editName.addEventListener("click",async()=>{
    const name=document.querySelector(".fullName").textContent;
    const newNameRaw=prompt('enter you full name',name);
    const newName=newNameRaw.trim().toUpperCase();
    if(newName===name){return alert(`new name can't be the same as old name`)};
    const result= await fetch("/api/editName",{
        method:"post",
        headers:{"content-Type":"application/json"},
        body:JSON.stringify({newName})
    })
    data=await result.json()
    if(result.status===200){
        fullName.textContent=await data.Name;
        errorBox.textContent=await data.message;
        errorBox.style.background='var(--clr-success)';
        errorBox.style.display='block';
        setTimeout(()=>{errorBox.style.display='none'},2500);
    }
})

rechargeButton.addEventListener("click",async()=>{
    const newBalanceRaw=prompt('Enter the deposit amount',100);
    const newBalance=Number( newBalanceRaw.trim());
    if(isNaN(newBalance)||newBalance<1||newBalance>1000){return alert("only numbers between 1 and 1000 allowed")}
    const result=await fetch("/api/editBalance",{
        method:"post",
        headers:{"content-Type":"application/json"},
        body:JSON.stringify({newBalance})
    })
    const data=await result.json(); 
    if(result.status===200){
        balance_div.textContent=await data.balance;
        errorBox.textContent=await data.message;
        errorBox.style.background='var(--clr-success)';
        errorBox.style.display='block';
        setTimeout(()=>{errorBox.style.display='none'},2500);
    }
    else if(result.status===400||result.status===401){
        errorBox.textContent=await data;
        errorBox.style.background='var(--clr-error)';
        errorBox.style.display='block';
        setTimeout(()=>{errorBox.style.display='none'},2500);
    }
});

async function transactionHistory(){
    const result =await fetch(`/traxHistory/${limit}/${offset}`);
    const data=await result.json();
    if(result.status===200){
        for(let i=0;i<data.length;i++){
            tCardCreater(data[i]);
            
        }
    }
    else if(result.status===400||result.status===500||result.status===404){
        return notification(0,data);
    }
    if(data.length<limit){
        more.disabled=true;
        more.textContent=' no more...';
        more.style.cursor='not-allowed';
        return;
     };

};

function tCardCreater(data){
    cardQuery=cardQuery+=`<div class="tlCard">
                <div class="first-container">
                <img src='${data.image}' class="product-image"></div>
                <div class="middle-container">
                    <div class="pTitle ">${data.name}</div>
                    <div class="pQuantity">Amount ${data.order_quantity}</div>
                    <div class="pPrice"><span style="color:gray;font-size:12px;font-weight:normal;">Total:</span> ${data.total}<span style="color:gray;font-size:12px;font-weight:normal;">${data.currencytype}</span></div>
                </div>
                <div class="last-container"><div class="status">${data.status}</div>
            <div class=" order-id">Orde Id: #<span style="color:blue; text-decoration:underline; cursor:pointer;">${data.order_id}</span></div>
        <div class=" created-at">${data.created_at}</div></div>
             </div>`
 transactionHistoryDiv.innerHTML=cardQuery
};

more.addEventListener("click",()=>{offset+=limit;transactionHistory();});

fetchUser();

document.addEventListener("DOMContentLoaded",()=>{
    tlCard.style.display='none';
    transactionHistory();
})

</script>
<script type="module">
//     import {products} from './data.js';
//     let id,quantity;
//     const balance_div=document.querySelector('.balance-div');

// let balance=localStorage.getItem('balance')||localStorage.setItem('balance',20000.01);
// balance_div.innerText=balance;
// const recharge_btn=document.querySelector('.recharge-button');
// recharge_btn.addEventListener('click',()=>{
//    let ammount= prompt('enter the amount to recharge',100);
//       if(!ammount){return}
//    if(ammount<=20000){
//    localStorage.setItem('balance',ammount);
//     balance=localStorage.getItem('balance')||0;
//    balance_div.innerText=balance;}

//    else{alert('ammount can not exced 20,000');}
// })
// const user_name_div=document.querySelector('.user-name');
// let user_name= localStorage.getItem('user-name')||localStorage.setItem('user-name','Your Name');
// user_name=localStorage.getItem('user-name')
// user_name_div.innerText=user_name
// const edit_name_btn=document.querySelector('.edit-name');
// edit_name_btn.addEventListener('click',()=>{
//   let new_name=  prompt('enter your name','your name');
//   if(!new_name){return;}
//   localStorage.setItem('user-name',new_name)
//   user_name_div.innerText=localStorage.getItem('user-name');
// })

// const search_input= document.querySelector('.search-input');

//  let search_input_value =search_input.value;
// const search_button=document.querySelector('.search-button');
// search_button.addEventListener('click',()=>{  
//      search_input_value =search_input.value.trim().toLowerCase();
//     location.href=`./products.html?search=${search_input_value}`;})



//     const transactionsList = document.getElementById('transactions-list');

//     function formatCurrency(n){
//         return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
//     }
//    let transactions=JSON.parse( localStorage.getItem('history'));

//     function renderTransactions(id,quantity){
//         if(!transactions || transactions.length==0){
//             transactionsList.innerHTML = '<p class="no-transactions">No transactions yet.</p>';
//             return;
//         }

//         transactionsList.innerHTML = `
//             <div class="transaction-card">
//                 <img src="${products[id].image}" alt="${products[id].name}" class="transaction-img">
//                 <div class="txn-details">
//                     <div class="txn-name">${products[id].name}</div>
//                     <div class="txn-meta">Quantity: <span class="txn-amount">${quantity}</span></div>
//                 </div>
              
//             </div>
//         `,        console.log('id=',id,typeof(id),typeof(quantity),'  quan=',quantity);;
  
//     }

    // Try to read transactions from localStorage; fall back to sample data
    // let storedTxns = null;
    // try{ storedTxns = JSON.parse(localStorage.getItem('history')); } catch(e){ storedTxns = null }

    // const sampleTransactions = [
    //     {id:1, img:'images/products/sample1.jpg', name:'Red Sneakers', amount:1, price:1299.00},
    //     {id:2, img:'images/products/sample2.jpg', name:'Bluetooth Headset', amount:2, price:799.50},
    //     {id:3, img:'images/products/sample3.jpg', name:'Coffee Mug', amount:3, price:149.99}
    // ];
//     for(let i=0;i<transactions.length;i++){
        
//              let transaction_array =transactions[i].replaceAll('{','').replaceAll('}','').split(',');
//               id = Number( transaction_array[0]);
//               quantity =Number( transaction_array[1]);

//              renderTransactions(id,quantity);
//     }

 </script>
</html>
